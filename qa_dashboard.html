<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAVA Health | QA Gates Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #15151f;
            --accent-red: #ff4757;
            --accent-green: #2ed573;
            --accent-blue: #3742fa;
            --accent-cyan: #00d4ff;
            --accent-orange: #ffa502;
            --accent-purple: #a55eea;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9e;
            --text-muted: #5a5a6e;
            --border-color: #2a2a3a;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(240, 147, 251, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 212, 255, 0.03) 0%, transparent 70%);
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: var(--gradient-3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        .title-block h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(90deg, #fff 0%, #00d4ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title-block p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .date-range {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }

        .date-range .label {
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .date-range .value {
            color: var(--accent-cyan);
            font-size: 14px;
            margin-top: 4px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-cyan);
            box-shadow: 0 8px 30px rgba(0, 212, 255, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-3);
        }

        .stat-card.danger::before {
            background: var(--gradient-2);
        }

        .stat-card.success::before {
            background: linear-gradient(90deg, #2ed573 0%, #7bed9f 100%);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-card.danger .stat-value {
            color: var(--accent-red);
        }

        .stat-card.success .stat-value {
            color: var(--accent-green);
        }

        .stat-change {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Filters Section */
        .filters-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters-header h3::before {
            content: '◉';
            color: var(--accent-cyan);
        }

        .reset-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Space Grotesk', sans-serif;
        }

        .reset-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .filter-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .filter-group select {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Space Grotesk', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b8b9e' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        .filter-group select:hover {
            border-color: var(--accent-cyan);
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }

        .chart-card.full-width {
            grid-column: span 2;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chart-subtitle {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 4px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-card.tall .chart-container {
            height: 400px;
        }

        /* Data Table */
        .table-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .table-count {
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-secondary);
            padding: 14px 20px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            transition: all 0.2s;
        }

        th:hover {
            color: var(--accent-cyan);
        }

        th.sortable::after {
            content: ' ↕';
            opacity: 0.3;
        }

        th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
            color: var(--accent-cyan);
        }

        th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
            color: var(--accent-cyan);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            vertical-align: top;
        }

        tr:hover td {
            background: rgba(0, 212, 255, 0.03);
        }

        .lot-id {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
            font-weight: 500;
        }

        .process-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .process-badge.outer-layer { background: rgba(102, 126, 234, 0.2); color: #667eea; }
        .process-badge.screen-print { background: rgba(255, 165, 2, 0.2); color: #ffa502; }
        .process-badge.final-inspection { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
        .process-badge.dispensing { background: rgba(240, 147, 251, 0.2); color: #f093fb; }
        .process-badge.other { background: rgba(139, 139, 158, 0.2); color: #8b8b9e; }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.release { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
        .status-badge.in-progress { background: rgba(255, 165, 2, 0.2); color: #ffa502; }
        .status-badge.disposition { background: rgba(79, 172, 254, 0.2); color: #4facfe; }
        .status-badge.approvals { background: rgba(165, 94, 234, 0.2); color: #a55eea; }
        .status-badge.other { background: rgba(139, 139, 158, 0.2); color: #8b8b9e; }

        .yield-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .yield-high { color: var(--accent-green); }
        .yield-medium { color: var(--accent-orange); }
        .yield-low { color: var(--accent-red); }

        .failure-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .failure-tag {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(255, 71, 87, 0.15);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 4px;
            font-size: 11px;
            color: var(--accent-red);
        }

        /* Expandable Row */
        .expand-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .expand-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .conclusion-text {
            max-width: 400px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-muted);
        }

        .loading::after {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-card.full-width {
                grid-column: span 1;
            }
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Top Failure Modes Panel */
        .top-failures-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .failure-bars {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .failure-bar-item {
            display: grid;
            grid-template-columns: 180px 1fr 80px;
            align-items: center;
            gap: 16px;
        }

        .failure-bar-label {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .failure-bar-track {
            height: 24px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .failure-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-red) 0%, #ff6b6b 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .failure-bar-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <div class="logo">SH</div>
                <div class="title-block">
                    <h1>QA Gates Analytics Dashboard</h1>
                    <p>Sensor Quality Control · 21 Week Overview</p>
                </div>
            </div>
            <div class="date-range">
                <div class="label">Data Range</div>
                <div class="value" id="dateRange">Loading...</div>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">Total QA Gates</div>
                <div class="stat-value" id="totalGates">-</div>
                <div class="stat-change">All processes combined</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Sensors Processed</div>
                <div class="stat-value" id="totalProcessed">-</div>
                <div class="stat-change">Total start quantity</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-label">Total Rejected</div>
                <div class="stat-value" id="totalRejected">-</div>
                <div class="stat-change">Sensors failed QA</div>
            </div>
            <div class="stat-card success">
                <div class="stat-label">Overall Yield</div>
                <div class="stat-value" id="overallYield">-</div>
                <div class="stat-change">Pass rate percentage</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg. Reject Rate</div>
                <div class="stat-value" id="avgRejectRate">-</div>
                <div class="stat-change">Per QA gate average</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-header">
                <h3>Filter Data</h3>
                <button class="reset-btn" onclick="resetFilters()">Reset Filters</button>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Process Type</label>
                    <select id="filterProcess" onchange="applyFilters()">
                        <option value="">All Processes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Assignee</label>
                    <select id="filterAssignee" onchange="applyFilters()">
                        <option value="">All Assignees</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Time Period</label>
                    <select id="filterTime" onchange="applyFilters()">
                        <option value="">All Time</option>
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Top Failure Modes Panel -->
        <div class="top-failures-panel">
            <div class="chart-header">
                <div>
                    <div class="chart-title">Top 10 Failure Modes</div>
                    <div class="chart-subtitle">Most common reasons for sensor rejection</div>
                </div>
            </div>
            <div class="failure-bars" id="failureBars">
                <div class="loading">Analyzing failure data</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card full-width tall">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Rejection Trend Over Time</div>
                        <div class="chart-subtitle">Weekly rejected quantity and yield percentage</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">QA Gates by Process</div>
                        <div class="chart-subtitle">Distribution across manufacturing steps</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="processChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Yield by Process Type</div>
                        <div class="chart-subtitle">Pass rate comparison</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="yieldByProcessChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">QA Gates by Assignee</div>
                        <div class="chart-subtitle">Work distribution</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="assigneeChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Status Distribution</div>
                        <div class="chart-subtitle">Current QA gate states</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-section">
            <div class="table-header">
                <h3>QA Gate Records</h3>
                <span class="table-count" id="tableCount">0 records</span>
            </div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="summary">Lot ID</th>
                            <th class="sortable" data-sort="process">Process</th>
                            <th class="sortable" data-sort="assignee">Assignee</th>
                            <th class="sortable" data-sort="created">Date</th>
                            <th class="sortable" data-sort="status">Status</th>
                            <th class="sortable" data-sort="startQty">Start Qty</th>
                            <th class="sortable" data-sort="rejectQty">Rejected</th>
                            <th class="sortable" data-sort="yield">Yield</th>
                            <th>Failure Modes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="9" class="loading">Loading data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let rawData = [];
        let filteredData = [];
        let charts = {};
        let currentSort = { column: 'created', direction: 'desc' };

        // CSV Data - embedded directly
        const csvData = `Issue Type,Issue key,Issue id,Summary,Assignee,Assignee Id,Status,Created,Custom field (Start Quantity),Custom field (Rejected Quantity),Custom field (Conclusion),Custom field (Sheet Numbers),Custom field (Rejected Sensors),Time Spent
QAG - Wearable Line - Outer Layer,QAG-499,37077,LN-R00186,Grace Chappell Facuse,712020:5316c26f-e0cc-4781-9709-8feff95c3e02,In Progress,26/Jan/26 2:35 PM,133.0,,,"Z32A-584

Z32A-586

Z32A-556

Z32A-585

Z32A-583",,
QAG - Wearable Line - Outer Layer,QAG-498,37075,LN-R00185,Grace Chappell Facuse,712020:5316c26f-e0cc-4781-9709-8feff95c3e02,Release,26/Jan/26 12:14 PM,144.0,7.0,"144 sensors are in this lot, 3 sensors were removed during Pre OL. 

7 sensors failed in total:

* 3 sensors removed at pre OL

* 1 sensor failed for bent needle
* 1 sensor failed for missing image
* 1 sensor failed for lumps
* 1 sensor failed for fibres

137 sensors will proceed to the next manufacturing step after being approved","Z31T-622

Z31T-620

Z31T-621

Z31U-612

Z31T-619

Z31U-615","||*Sensor ID*||*Failure Mode*||
|Z31T-619-F3|Bent Needle|
|Z31T-619-F6|Missing Image|
|Z31T-620-E2|Sensor Removed|
|Z31T-621-C8|Sensor Removed|
|Z31T-621-D2|Sensor Removed|
|Z31T-622-C2|Lumps|
|Z31U-612-A7|Fibre|",
QAG - Wearable Line - Outer Layer,QAG-495,36849,LN-R00184,Grace Chappell Facuse,712020:5316c26f-e0cc-4781-9709-8feff95c3e02,In Progress,22/Jan/26 11:36 AM,12.0,2.0,"This lot has 12 sensors, after review, 2 sensors are rejected due to Bent needle and Lumps. 

Multiple sensors in this lot exceed the 30 micron thick threshold, it has been requested from the head of BIVP that we ignore the thresholds and only fail for cosmetic failures. 

10 sensors will proceed to the next manufacturing step",Z32A-549,"||*Sensor ID*||*Failure Modes*||
|Z32A-549-D5|Bent Needle|
|Z32A-549-F5|Lumps|",`;

        // Parse CSV
        function parseCSV(csv) {
            return new Promise((resolve) => {
                Papa.parse(csv, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        resolve(results.data);
                    }
                });
            });
        }

        // Load data from file
        async function loadData() {
            try {
                const response = await fetch('Jira__11_.csv');
                const text = await response.text();
                rawData = await parseCSV(text);
            } catch (e) {
                // Fallback to embedded sample data if file not found
                rawData = await parseCSV(csvData);
            }
            
            processData();
            populateFilters();
            applyFilters();
        }

        // Process raw data
        function processData() {
            rawData = rawData.map(row => {
                const startQty = parseFloat(row['Custom field (Start Quantity)']) || 0;
                const rejectQty = parseFloat(row['Custom field (Rejected Quantity)']) || 0;
                const yieldPct = startQty > 0 ? ((startQty - rejectQty) / startQty * 100) : 100;
                
                // Extract process type from Issue Type
                let process = 'Other';
                const issueType = row['Issue Type'] || '';
                if (issueType.includes('Outer Layer')) process = 'Outer Layer';
                else if (issueType.includes('Screen Print')) process = 'Screen Print';
                else if (issueType.includes('Final Inspection')) process = 'Final Inspection';
                else if (issueType.includes('Dispensing')) process = 'Dispensing';
                else if (issueType.includes('Reader')) process = 'Reader Line';
                
                // Extract failure modes from conclusion and rejected sensors
                const failureModes = extractFailureModes(
                    (row['Custom field (Conclusion)'] || '') + ' ' + 
                    (row['Custom field (Rejected Sensors)'] || '')
                );
                
                // Parse date
                let createdDate = null;
                const dateStr = row['Created'];
                if (dateStr) {
                    // Format: "26/Jan/26 2:35 PM"
                    const parts = dateStr.match(/(\d+)\/(\w+)\/(\d+)\s+(\d+):(\d+)\s*(AM|PM)?/i);
                    if (parts) {
                        const months = { Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5, 
                                        Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11 };
                        let year = parseInt(parts[3]);
                        if (year < 100) year += 2000;
                        let hour = parseInt(parts[4]);
                        if (parts[6] === 'PM' && hour !== 12) hour += 12;
                        if (parts[6] === 'AM' && hour === 12) hour = 0;
                        createdDate = new Date(year, months[parts[2]], parseInt(parts[1]), hour, parseInt(parts[5]));
                    }
                }
                
                return {
                    ...row,
                    process,
                    startQty,
                    rejectQty,
                    yield: yieldPct,
                    failureModes,
                    createdDate,
                    assignee: row['Assignee'] || 'Unassigned',
                    status: row['Status'] || 'Unknown',
                    summary: row['Summary'] || ''
                };
            }).filter(row => row.createdDate);
            
            // Sort by date descending
            rawData.sort((a, b) => b.createdDate - a.createdDate);
        }

        // Extract failure modes from text
        function extractFailureModes(text) {
            if (!text) return [];
            
            const modes = new Set();
            const patterns = [
                /fibre/gi, /fiber/gi, /bent needle/gi, /bent/gi, /lumps/gi, /damage/gi,
                /missing image/gi, /print incomplete/gi, /missing/gi, /sensor removed/gi,
                /needle width/gi, /bridging/gi, /excess glue/gi, /adhesive/gi,
                /height/gi, /bad print/gi, /overprint/gi, /no measurements/gi,
                /poor dispense/gi, /dispense/gi, /debris/gi, /contamination/gi,
                /measurement error/gi, /imaging fail/gi, /bulging/gi, /excess ink/gi
            ];
            
            patterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(m => {
                        let mode = m.toLowerCase().trim();
                        // Normalize common variations
                        if (mode === 'fiber' || mode === 'fibre') mode = 'Fibre';
                        else if (mode.includes('bent')) mode = 'Bent Needle';
                        else if (mode.includes('lump')) mode = 'Lumps';
                        else if (mode.includes('removed')) mode = 'Sensor Removed';
                        else if (mode.includes('width')) mode = 'Needle Width';
                        else if (mode.includes('print') && mode.includes('incomplete')) mode = 'Print Incomplete';
                        else if (mode.includes('bad print')) mode = 'Bad Print';
                        else if (mode.includes('damage')) mode = 'Damaged';
                        else if (mode.includes('bridging')) mode = 'Bridging';
                        else if (mode.includes('adhesive')) mode = 'Adhesive Issue';
                        else if (mode.includes('height')) mode = 'Height';
                        else if (mode.includes('dispense')) mode = 'Poor Dispense';
                        else if (mode.includes('missing')) mode = 'Missing Image';
                        else if (mode.includes('overprint')) mode = 'Overprint';
                        else if (mode.includes('excess ink')) mode = 'Excess Ink/Lumps';
                        else if (mode.includes('bulging')) mode = 'Bulging Needle';
                        else mode = mode.charAt(0).toUpperCase() + mode.slice(1);
                        
                        modes.add(mode);
                    });
                }
            });
            
            return Array.from(modes);
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Processes
            const processes = [...new Set(rawData.map(r => r.process))].sort();
            const processSelect = document.getElementById('filterProcess');
            processes.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                processSelect.appendChild(opt);
            });
            
            // Assignees
            const assignees = [...new Set(rawData.map(r => r.assignee))].filter(a => a).sort();
            const assigneeSelect = document.getElementById('filterAssignee');
            assignees.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a;
                opt.textContent = a;
                assigneeSelect.appendChild(opt);
            });
            
            // Statuses
            const statuses = [...new Set(rawData.map(r => r.status))].sort();
            const statusSelect = document.getElementById('filterStatus');
            statuses.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                statusSelect.appendChild(opt);
            });
        }

        // Apply filters
        function applyFilters() {
            const processFilter = document.getElementById('filterProcess').value;
            const assigneeFilter = document.getElementById('filterAssignee').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const timeFilter = parseInt(document.getElementById('filterTime').value) || 0;
            
            const now = new Date();
            const cutoffDate = timeFilter > 0 ? new Date(now - timeFilter * 24 * 60 * 60 * 1000) : null;
            
            filteredData = rawData.filter(row => {
                if (processFilter && row.process !== processFilter) return false;
                if (assigneeFilter && row.assignee !== assigneeFilter) return false;
                if (statusFilter && row.status !== statusFilter) return false;
                if (cutoffDate && row.createdDate < cutoffDate) return false;
                return true;
            });
            
            updateDashboard();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterProcess').value = '';
            document.getElementById('filterAssignee').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterTime').value = '';
            applyFilters();
        }

        // Update entire dashboard
        function updateDashboard() {
            updateStats();
            updateDateRange();
            updateFailureBars();
            updateCharts();
            updateTable();
        }

        // Update statistics
        function updateStats() {
            const totalGates = filteredData.length;
            const totalProcessed = filteredData.reduce((sum, r) => sum + r.startQty, 0);
            const totalRejected = filteredData.reduce((sum, r) => sum + r.rejectQty, 0);
            const overallYield = totalProcessed > 0 ? ((totalProcessed - totalRejected) / totalProcessed * 100) : 100;
            const avgRejectRate = totalGates > 0 ? (totalRejected / totalGates) : 0;
            
            document.getElementById('totalGates').textContent = totalGates.toLocaleString();
            document.getElementById('totalProcessed').textContent = totalProcessed.toLocaleString();
            document.getElementById('totalRejected').textContent = totalRejected.toLocaleString();
            document.getElementById('overallYield').textContent = overallYield.toFixed(1) + '%';
            document.getElementById('avgRejectRate').textContent = avgRejectRate.toFixed(1);
        }

        // Update date range display
        function updateDateRange() {
            if (filteredData.length === 0) {
                document.getElementById('dateRange').textContent = 'No data';
                return;
            }
            
            const dates = filteredData.map(r => r.createdDate).filter(d => d);
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            const format = d => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' });
            document.getElementById('dateRange').textContent = `${format(minDate)} → ${format(maxDate)}`;
        }

        // Update failure mode bars
        function updateFailureBars() {
            const failureCounts = {};
            filteredData.forEach(row => {
                row.failureModes.forEach(mode => {
                    failureCounts[mode] = (failureCounts[mode] || 0) + 1;
                });
            });
            
            const sorted = Object.entries(failureCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const maxCount = sorted.length > 0 ? sorted[0][1] : 1;
            
            const container = document.getElementById('failureBars');
            
            if (sorted.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 40px;">No failure modes detected in filtered data</div>';
                return;
            }
            
            container.innerHTML = sorted.map(([mode, count]) => `
                <div class="failure-bar-item">
                    <div class="failure-bar-label" title="${mode}">${mode}</div>
                    <div class="failure-bar-track">
                        <div class="failure-bar-fill" style="width: ${(count / maxCount * 100)}%"></div>
                    </div>
                    <div class="failure-bar-value">${count}</div>
                </div>
            `).join('');
        }

        // Update all charts
        function updateCharts() {
            updateTrendChart();
            updateProcessChart();
            updateYieldByProcessChart();
            updateAssigneeChart();
            updateStatusChart();
        }

        // Trend chart
        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Group by week
            const weeklyData = {};
            filteredData.forEach(row => {
                if (!row.createdDate) return;
                const weekStart = new Date(row.createdDate);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = { start: 0, rejected: 0, count: 0 };
                }
                weeklyData[weekKey].start += row.startQty;
                weeklyData[weekKey].rejected += row.rejectQty;
                weeklyData[weekKey].count++;
            });
            
            const sortedWeeks = Object.keys(weeklyData).sort();
            const labels = sortedWeeks.map(w => {
                const d = new Date(w);
                return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            });
            const rejectedData = sortedWeeks.map(w => weeklyData[w].rejected);
            const yieldData = sortedWeeks.map(w => {
                const d = weeklyData[w];
                return d.start > 0 ? ((d.start - d.rejected) / d.start * 100) : 100;
            });
            
            if (charts.trend) charts.trend.destroy();
            
            charts.trend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Rejected Sensors',
                            data: rejectedData,
                            backgroundColor: 'rgba(255, 71, 87, 0.7)',
                            borderColor: '#ff4757',
                            borderWidth: 1,
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Yield %',
                            data: yieldData,
                            type: 'line',
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#00d4ff',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#8b8b9e', font: { family: 'Space Grotesk' } }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: { color: '#8b8b9e' }
                        },
                        y: {
                            position: 'left',
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: { color: '#ff4757' },
                            title: { display: true, text: 'Rejected Qty', color: '#ff4757' }
                        },
                        y1: {
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: { display: false },
                            ticks: { color: '#00d4ff' },
                            title: { display: true, text: 'Yield %', color: '#00d4ff' }
                        }
                    }
                }
            });
        }

        // Process distribution chart
        function updateProcessChart() {
            const ctx = document.getElementById('processChart').getContext('2d');
            
            const processCounts = {};
            filteredData.forEach(row => {
                processCounts[row.process] = (processCounts[row.process] || 0) + 1;
            });
            
            const colors = {
                'Outer Layer': '#667eea',
                'Screen Print': '#ffa502',
                'Final Inspection': '#2ed573',
                'Dispensing': '#f093fb',
                'Reader Line': '#00d4ff',
                'Other': '#8b8b9e'
            };
            
            const labels = Object.keys(processCounts);
            const data = Object.values(processCounts);
            const bgColors = labels.map(l => colors[l] || colors['Other']);
            
            if (charts.process) charts.process.destroy();
            
            charts.process = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: bgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#8b8b9e', font: { family: 'Space Grotesk' }, padding: 15 }
                        }
                    }
                }
            });
        }

        // Yield by process chart
        function updateYieldByProcessChart() {
            const ctx = document.getElementById('yieldByProcessChart').getContext('2d');
            
            const processYield = {};
            filteredData.forEach(row => {
                if (!processYield[row.process]) {
                    processYield[row.process] = { start: 0, rejected: 0 };
                }
                processYield[row.process].start += row.startQty;
                processYield[row.process].rejected += row.rejectQty;
            });
            
            const labels = Object.keys(processYield);
            const data = labels.map(p => {
                const d = processYield[p];
                return d.start > 0 ? ((d.start - d.rejected) / d.start * 100) : 100;
            });
            
            if (charts.yieldByProcess) charts.yieldByProcess.destroy();
            
            charts.yieldByProcess = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Yield %',
                        data,
                        backgroundColor: data.map(v => v >= 90 ? '#2ed573' : v >= 80 ? '#ffa502' : '#ff4757'),
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: { color: '#8b8b9e' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#8b8b9e' }
                        }
                    }
                }
            });
        }

        // Assignee chart
        function updateAssigneeChart() {
            const ctx = document.getElementById('assigneeChart').getContext('2d');
            
            const assigneeCounts = {};
            filteredData.forEach(row => {
                const name = row.assignee.split(' ')[0]; // First name only
                assigneeCounts[name] = (assigneeCounts[name] || 0) + 1;
            });
            
            const sorted = Object.entries(assigneeCounts).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(s => s[0]);
            const data = sorted.map(s => s[1]);
            
            if (charts.assignee) charts.assignee.destroy();
            
            charts.assignee = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'QA Gates',
                        data,
                        backgroundColor: '#4facfe',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#8b8b9e' }
                        },
                        y: {
                            grid: { color: 'rgba(42, 42, 58, 0.5)' },
                            ticks: { color: '#8b8b9e' }
                        }
                    }
                }
            });
        }

        // Status chart
        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            const statusCounts = {};
            filteredData.forEach(row => {
                statusCounts[row.status] = (statusCounts[row.status] || 0) + 1;
            });
            
            const colors = {
                'Release': '#2ed573',
                'In Progress': '#ffa502',
                'Disposition': '#4facfe',
                'Approvals': '#a55eea'
            };
            
            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            const bgColors = labels.map(l => colors[l] || '#8b8b9e');
            
            if (charts.status) charts.status.destroy();
            
            charts.status = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: bgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#8b8b9e', font: { family: 'Space Grotesk' }, padding: 15 }
                        }
                    }
                }
            });
        }

        // Update data table
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            document.getElementById('tableCount').textContent = `${filteredData.length} records`;
            
            // Sort data
            const sorted = [...filteredData].sort((a, b) => {
                let aVal, bVal;
                switch (currentSort.column) {
                    case 'summary': aVal = a.summary; bVal = b.summary; break;
                    case 'process': aVal = a.process; bVal = b.process; break;
                    case 'assignee': aVal = a.assignee; bVal = b.assignee; break;
                    case 'created': aVal = a.createdDate || new Date(0); bVal = b.createdDate || new Date(0); break;
                    case 'status': aVal = a.status; bVal = b.status; break;
                    case 'startQty': aVal = a.startQty; bVal = b.startQty; break;
                    case 'rejectQty': aVal = a.rejectQty; bVal = b.rejectQty; break;
                    case 'yield': aVal = a.yield; bVal = b.yield; break;
                    default: aVal = a.createdDate || new Date(0); bVal = b.createdDate || new Date(0);
                }
                
                if (typeof aVal === 'string') {
                    return currentSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            tbody.innerHTML = sorted.map(row => {
                const processClass = row.process.toLowerCase().replace(/\s+/g, '-');
                const statusClass = row.status.toLowerCase().replace(/\s+/g, '-');
                const yieldClass = row.yield >= 90 ? 'yield-high' : row.yield >= 80 ? 'yield-medium' : 'yield-low';
                const dateStr = row.createdDate ? row.createdDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' }) : '-';
                
                return `
                    <tr>
                        <td><span class="lot-id">${row.summary}</span></td>
                        <td><span class="process-badge ${processClass}">${row.process}</span></td>
                        <td>${row.assignee.split(' ')[0]}</td>
                        <td>${dateStr}</td>
                        <td><span class="status-badge ${statusClass}">${row.status}</span></td>
                        <td>${row.startQty || '-'}</td>
                        <td>${row.rejectQty || 0}</td>
                        <td class="yield-cell ${yieldClass}">${row.yield.toFixed(1)}%</td>
                        <td>
                            <div class="failure-tags">
                                ${row.failureModes.slice(0, 4).map(m => `<span class="failure-tag">${m}</span>`).join('')}
                                ${row.failureModes.length > 4 ? `<span class="failure-tag">+${row.failureModes.length - 4}</span>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Table sorting
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                
                // Update sort state
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'desc';
                }
                
                // Update header classes
                document.querySelectorAll('th.sortable').forEach(t => {
                    t.classList.remove('sort-asc', 'sort-desc');
                });
                th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                
                updateTable();
            });
        });

        // Initialize
        loadData();
    </script>
</body>
</html>